<!DOCTYPE html>
<html lang="en">
<head>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="font-awesome.css">
<style>
    .switch { 
    	height: 30px;
    	float: left;
    	margin-top: 20px;
    	margin-left: 10px;
    }
    .toggle-text {
    	height: 10px;
    	font-family: "Comic Sans MS";
    	font-size: 15px;
    	margin-top: 0px;
    	margin-left: 35px;
    	text-align: left;
    }
    input.cmn-toggle-round-flat + label {
    	width: 120px;
        height: 40px;

    }
    .arc text { font-family: "Comic Sans MS"; font-size: 5px; }
    .arc path { stroke: #fff; }
    .tooltip { position: absolute;           
        text-align: center;           
        width: 200px;                  
        height: 300px;                 
        padding: 2px;             
        font: 12px sans-serif;        
        background: lightsteelblue;   
        border: 1px solid green;      
        border-radius: 8px;           
        pointer-events: none; 
    }
    svg { background-color: white }
    .panel-info { height: 200px; width: 940px; margin-left: 160px; margin-right: 200px; margin-bottom: 0px; border: none; }
    .panel-heading { height: 60px; width: 400px; margin-left: 270px; margin-top: 15px; }
    .heading-text { font-family: "Comic Sans MS"; text-align: center; padding-top: 17px; font-size: 20px; }
    .info-heading { height: 60px; width: 180px; margin-left: 24px; margin-bottom: 0px; }
    .btn-text { font-family: "Comic Sans MS"; }
    .panel-body { margin-left: 10px; margin-right: 10px; padding-top: 0px; margin-top: 0px; margin-bottom: 0px; }
    .btn-primary { margin-left: 0px; padding-left: 10px; width: 140px; margin-top: 20px; }
    .panel-success { position: absolute; height: 600px; width: 230px; outline: 5px solid green; box-shadow: 5px 5px;}
    .state-boundary { fill: #DCDCDC; stroke: #ccc; }
    .state-name { fill: #000000; fill-opacity: .8; font-size: 8px; font-weight: 300; text-anchor: middle; }
    .location { fill: red; fill-opacity: .8; }
    .well { position: static; margin-top: 20px; margin-bottom: 0px; height: 40px; width: 180px; margin-left: 0px; padding-top: 7px; }
    .well-text { font-family: "Comic Sans MS"; padding-left: 23px; color: #F7356A; font-size: 6px; }
    .donutChart { margin-top: 0px; padding-top: 0px; margin-bottom: 0px; }
    .legend { margin-left: 10px; }
    .legendText { text-anchor: middle; font-size: 10px; }
    .donutChartLegendText { font-size: 10px; text-anchor: middle; }
    .donutChartLegendRect { width: 40px; height: 10px; }
    .mapLegendRect { width: 50px; height: 10px; }
</style>
</head>
<body>
<div id="panel" class="panel panel-info">
	<div class="panel-heading heading-text">Select a crime type to display!</div>
    <div class="panel-body">
    	<button id="race" type="button" class="btn btn-primary btn-text">Race</button>
    	<button id="religion" type="button" class="btn btn-primary btn-text">Religion</button>
    	<button id="sex" type="button" class="btn btn-primary btn-text">Sexual Orientation</button>
    	<button id="ethnicity" type="button" class="btn btn-primary btn-text">Ethnicity</button>
    	<button id="disability" type="button" class="btn btn-primary btn-text">Disability</button>
    	<button id="gender" type="button" class="btn btn-primary btn-text">Gender</button> 
    </div>
    <div class="toggle-text">Ratio</div>
    <div class="switch">
        <input id="toggle" class="cmn-toggle cmn-toggle-round-flat" type="checkbox" value="false">
        <label for="toggle"></label>
    </div>    
</div>
<div id="map"></div>
<div id="info" class="panel panel-success" style="visibility: hidden">
	<div class="panel-heading heading-text info-heading" style="font-size: 15px">Hate Crime Info</div>
    <div class="panel-body">
    	<div id="city" class="well well-text" style="text-align: center"></div>
    	<div id="population" class="well well-text" style="text-align: center"></div>
    	<div id="crime" class="well well-text" style="text-align: center"></div>
    	<div id="rank" class="well well-text" style="text-align: center"></div>
    </div>
</div>
<script>
var width = 1220;
var height = 600;
var clickedID;

var projection = d3.geo.albersUsa().scale(1150).translate([width/2, height/2]);

var path = d3.geo.path().projection(projection);

var svg = d3.select("#map").append("svg")
    .attr("class", "svg-color")
    .attr("width", width)
    .attr("height", height);

var states;
d3.json("../data/us.json", function(error, shapes){
	if(error){ console.log(error); }
    states = topojson.feature(shapes, shapes.objects.states).features;
    var statePaths = svg.append("g");
    statePaths.selectAll("path").data(states).enter()
    .append("path")
    .attr("d", path)
    .attr("class", "state-boundary");
    
    d3.tsv("../data/us-state-names.tsv", function(rows){
    	var names = {};
    	rows.forEach(function(d, i){
            names[d.id] = d.name;
    	});
        //filtered NaN values
        var filteredStates = states.filter(function(state){ return isNaN(path.centroid(state)[0])!=true && isNaN(path.centroid(state)[1])!=true; });
    	//add state names
    	var stateNames = svg.append("g");
    	
    	stateNames.selectAll("text")
    	.data(filteredStates).enter()
    	.append("text")
    	.attr("x", function(d){ return path.centroid(d)[0]; })
    	.attr("y", function(d){ return path.centroid(d)[1]; })
    	.attr("class", "state-name")
    	.text(function(d){ return names[d.id]; });
    	
    });
});

d3.csv("../data/hate-crime.csv", function(error, rows){
	var toggleOn = false;
	if(error){ console.log(error); }
	var toggle = d3.select("#toggle").on("change", function(d){
	    if(d3.select(this).node().value == "false"){
		    d3.select(this).node().value = "true";
		    toggleOn = true;
	    }
	    else{
            d3.select(this).node().value = "false";
            toggleOn = false;
	    }
        if(d3.selectAll("circle") != undefined){ 
        	d3.selectAll("circle").remove();
        	generateMapLegend(toggleOn);
        	switch(clickedID){
        		case "race":
        		    displayLocations(rows, "Race", 40, toggleOn);
        		    break;
        		case "religion":
                    displayLocations(rows, "Religion", 20, toggleOn);
                    break;
                case "sex":
                    displayLocations(rows, "Sexual Orientation", 20, toggleOn);
                    break;
                case "ethnicity":
                    displayLocations(rows, "Ethnicity", 20, toggleOn);
                    break;
                case "disability":
                    displayLocations(rows, "Disability", 10, toggleOn);
                    break;
                case "gender":
                    displayLocations(rows, "Gender", 10, toggleOn);
                    break;
        	}
        }
    });
    //race 30 disability 10 gender 4 gender identity 10 religion 20
    d3.select("#race").on("click", function(){
    	generateMapLegend(toggleOn);
        clickedID = this.id;
        console.log("The current cliked button's id is "+clickedID);
    	svg.selectAll("circle").remove();
    	displayLocations(rows, "Race", 40, toggleOn); 
    });

    d3.select("#religion").on("click", function(){ 
    	generateMapLegend(toggleOn);
    	clickedID = this.id;
    	svg.selectAll("circle").remove();
    	displayLocations(rows, "Religion", 20, toggleOn);
    });

    d3.select("#sex").on("click", function(){
    	generateMapLegend(toggleOn);
    	clickedID = this.id;
        svg.selectAll("circle").remove();
        displayLocations(rows, "Sexual Orientation", 20, toggleOn);
    });

    d3.select("#ethnicity").on("click", function(){
    	generateMapLegend(toggleOn);
    	clickedID = this.id;
        svg.selectAll("circle").remove();
        displayLocations(rows, "Ethnicity", 20, toggleOn);
    });

    d3.select("#disability").on("click", function(){
    	generateMapLegend(toggleOn);
    	clickedID = this.id;
        svg.selectAll("circle").remove();
        displayLocations(rows, "Disability", 10, toggleOn);
    });

    d3.select("#gender").on("click", function(){
    	generateMapLegend(toggleOn);
    	clickedID = this.id;
        svg.selectAll("circle").remove();
        displayLocations(rows, "Gender", 10, toggleOn);
    });
});

function displayLocations(rows, crimeType, topNum, toggleOn){
    var arr = [];
    var numbers = [];
    var crimeTypes = ["Race", "Religion", "Sexual Orientation", "Ethnicity", "Disability", "Gender"];
    //extract relevant values from the csv files
    rows.forEach(function(row){
    	var record;
    	if(toggleOn == true){
    		var tmp = Number((Number(row[crimeType])/Number(row["Population"].replace(new RegExp(',', 'g'), ''))).toFixed(6));
            record = { stateCode: row["State Code"], city: row["Agency Name"], crime: tmp, population: row["Population"] };
    	}
    	else{
    	    record = { stateCode: row["State Code"], city: row["Agency Name"], crime: Number(row[crimeType]), population: row["Population"] };
        }
    	var total = 0;
    	if(toggleOn == true){
    		crimeTypes.forEach(function(d){
        		total += Number(row[d]);
        		var tmp = Number((Number(row[d])/Number(row["Population"].replace(new RegExp(',', 'g'), ''))).toFixed(6));
        		numbers.push(tmp);
        	});
        }
        else{
        	crimeTypes.forEach(function(d){
    		    total += Number(row[d]);
    		    numbers.push(Number(row[d]));
    	    });
        }
    	var ratios = [];
        crimeTypes.forEach(function(d){
            ratios.push({ type: d, ratio: Number(row[d])/total });
        });
        record["ratios"] = ratios;
        arr.push(record);
    });
    //filter the result array be selecting the topNum cities
    arr.sort(function(a, b){
    	return b.crime-a.crime;
    });
    var filteredCities = arr.slice(0, topNum);
    filteredCities.forEach(function(d, i){
        d["rank"] = i+1;
    });
    //different domains of legend color scales
    var input = [];
    if(toggleOn == true){
        var newNumbers = numbers.map(function(d){
    	    //return Number((d*1000000).toFixed(2));
    	    return d*10000;
        });
        var min = d3.min(newNumbers, function(d){ return d; });
        var max = d3.max(newNumbers, function(d){ return d; });
        var increment = (max-min)/6;
        for(var i=0;i<7;i++){
    	    if(i == 6){
    		    input.push(Number(max.toFixed(2)));
    	    }
    	    else{
    	        input.push(Number((min+i*increment).toFixed(2)));
            }
        }
    }
    else{
        var min = d3.min(numbers, function(d){ return d; });
        var max = d3.max(numbers, function(d){ return d; });
        var increment = (max-min)/6;
        for(var i=0;i<7;i++){
    	    if(i == 6){
    		    input.push(max);
    	    }
    	    else{
    	        input.push(min+i*increment);
            }
        }
    }
    var colorScale = d3.scale.linear()
    .domain(input)
    .range([ "#F5D0A9", "#FAAC58", "#FF8000", "#DF7401", "#FE2E2E", "#DF0101" ]);

    //add longitude and latitude to every city in the filtered array
    d3.csv("../data/us-cities.csv", function(error, cities){
        if(error){ console.log(error); }
        filteredCities.forEach(function(d){
        	var city = cities.find(function(c){
        		return d.stateCode == c.state && d.city == c.city;
        	});
        	d["longitude"] = city.lng;
        	d["latitude"] = city.lat;
        });

        //display the locations
        var locations = svg.append("g").attr("id", "locations");
        locations.selectAll("circle").data(filteredCities)
        .enter()
        .append("circle")
        .attr("transform", function(d){ return "translate("+projection([d.longitude, d.latitude])+")"; })
        .attr("r", 5)
        .style("fill", function(d){
        	if(toggleOn == true){
        		return colorScale(d.crime*10000);
        	}
        	else{
        	    return colorScale(d.crime);
        	} 
        })
        .on("mouseover", function(d){
        	var panel = d3.select("#info")
        	.style("visibility", "visible");
            var panelHeight = 430;
            var x = d3.mouse(svg.node())[0];
            var y = d3.mouse(svg.node())[1];
            if(y+panelHeight<=height){
            	panel.style("left", (d3.event.pageX-10)+"px")
                .style("top", (d3.event.pageY-150)+"px");
            }
            else{
            	panel.style("left", (d3.event.pageX-10)+"px")
                .style("top", (d3.event.pageY-460)+"px");
            }

        	d3.select("#city")
            .html("City: "+d.city);
        	
        	d3.select("#population")
        	.html("Population: "+d.population);

            if(toggleOn == true){
            	d3.select("#crime")
        	    .html(crimeType+": "+(d.crime*10000).toFixed(2));
        	    
            }
            else{
            	d3.select("#crime")
        	    .html(crimeType+": "+d.crime);       	    
            }

        	d3.select("#rank")
        	.html("Rank: "+d.rank);

        	displayDonutChart(d.ratios);
        })
        .on("mouseout", function(d){
        	d3.select("#legend").remove();
            d3.select("#donutChart").remove();
        	d3.select("#info").style("visibility", "hidden");
        });
    });    
}

function displayDonutChart(ratios){

	var crimes = ["Race", "Religion", "Ethnicity", "Disability", "Gender", "Sexual Orientation"];
	var dheight = 160;
	var dwidth = 220;
	var radius = Math.min(dheight, dwidth)/2;

	var lheight = 100;
	var lwidth = 220;
    
	var colorScale = d3.scale.ordinal().domain(crimes).range(["red", "green", "blue", "yellow", "purple", "grey"]);
    
    var arc = d3.svg.arc()
        .outerRadius(radius-5)
        .innerRadius(radius-45);

    var pie = d3.layout.pie()
        .sort(null)
        .value(function(d){ return d["ratio"]; });

    var lsvg = d3.select("#info").append("svg")
        .attr("id", "legend")
        .attr("class", "donutChart")
        .attr("width", lwidth)
        .attr("height", lheight);

    var dsvg = d3.select("#info").append("svg")
        .attr("id", "donutChart")
        .attr("class", "donutChart")
        .attr("width", dwidth)
        .attr("height", dheight)
        .append("g")
        .attr("transform", "translate("+dwidth/2+","+dheight/2+")");
    
    generateDonutChartLegend(lsvg);

    var g = dsvg.selectAll(".arc")
        .data(pie(ratios))
        .enter()
        .append("g")
        .attr("class", "arc");
    
    g.append("path")
     .attr("d", arc)
     .style("fill", function(d){ 
         return colorScale(d.data.type);
     });
    
    g.append("text")
     .attr("transform", function(d){ return "translate("+arc.centroid(d)+")"; })
     .attr("dx", ".5em")
     .attr("dy", ".5em")
     .text(function(d){ 
     	if(d.data["ratio"]!=0.0){
     	    return (d.data["ratio"]*100).toFixed(1)+"%";
     	} 
     })
     .style("font-size", "-10")
     .style("text-anchor", "middle")
     .style("fill", "black");
}

function generateDonutChartLegend(svg){
	var textInfo = [{ x: 20, y: 10, text: "Race" }, { x: 133, y: 10, text: "Religion" }, { x: 25, y: 45, text: "Ethnicity" }, 
	{ x: 145, y: 45, text: "Disability" }, { x: 80, y: 70, text: "Gender" }, { x: 80, y: 85, text: "Sexual Orientation"}];

    var rectInfo = [{ x: 40, y: 0, color: "red" }, { x: 165, y: 0, color: "green" }, { x: 60, y: 35, color: "blue" }, { x: 175, y: 35, color: "yellow" }, { x: 110, y: 60, color: "purple" }, { x: 140, y: 75, color: "grey" }];

	svg.selectAll(".donutChartLegendText").data(textInfo)
	.enter()
	.append("text")
	.attr("class", "donutChartLegendText")
	.attr("x", function(d){ return d.x; })
	.attr("y", function(d){ return d.y; })
	.text(function(d){ return d.text; });

    svg.selectAll(".donutChartLegendRect").data(rectInfo)
    .enter()
    .append("rect")
    .attr("class", "donutChartLegendRect")
    .attr("x", function(d){ return d.x; })
    .attr("y", function(d){ return d.y; })
    .style("fill", function(d){ return d.color; });
}

function generateMapLegend(toggleOn){
	d3.selectAll(".legendText").remove();

    var rectInfo = [{ x: 700, y: 0, color: "#F5D0A9"}, { x: 760, y: 0, color: "#FAAC58" }, { x: 820, y: 0, color: "#FF8000" }, 
    { x: 880, y: 0, color: "#DF7401" }, { x: 940, y: 0, color:"#FE2E2E" }, { x: 1000, y: 0, color: "#DF0101" }];

    var toggleOffTextInfo = [{ x: 725, y: 30, text: "0~25" }, { x: 785, y: 30, text: "25~50" }, { x: 845, y: 30, text: "50~75" }, 
    { x: 905, y: 30, text: "75~100" }, { x: 965, y: 30, text: "100~125" }, { x: 1025, y: 30, text: "125~152" }];
    
    var toggleOnTextInfo = [{ x: 725, y: 30, text: "0~5.43" }, { x: 785, y: 30, text: "5.43~10.86" }, { x: 845, y: 30, text:"10.86~16.29" }, 
    { x: 905, y: 30, text: "16.29~21.71" }, { x: 965, y: 30, text: "21.71~27.14" }, { x: 1025, y:30, text: "27.14~32.57" }];

    svg.selectAll(".mapLegendRect").data(rectInfo)
    .enter()
    .append("rect")
    .attr("class", "mapLegendRect")
    .attr("x", function(d){ return d.x; })
    .attr("y", function(d){ return d.y; })
    .style("fill", function(d){ return d.color; });

    if(toggleOn == false){
    	svg.selectAll(".legendText").data(toggleOffTextInfo)
    	.enter()
    	.append("text")
    	.attr("class", "legendText")
    	.attr("x", function(d){ return d.x; })
    	.attr("y", function(d){ return d.y; })
    	.text(function(d){ return d.text; });
    }
    else{
        svg.selectAll(".legendText").data(toggleOnTextInfo)
        .enter()
        .append("text")
        .attr("class", "legendText")
        .attr("x", function(d){ return d.x; })
        .attr("y", function(d){ return d.y; })
        .text(function(d){ return d.text; });
    }
    svg.append("text")
    .attr("x", 920)
    .attr("y", 50)
    .style("text-anchor", "middle")
    .style("font-size", "9px")
    .text("*When the toggle is turned on, the magnitude of the criminal stats is measured by ten thousandth.");
    //'* Sex stands for "Sexual Orientation"'
}
</script>
</body>
</html>